<center><h1>微信小程序</h1></center>

# 一、小程序语法

## 1. MINA框架目录

### 1.1 目录结构

- pages`：页面目录
  - index
    - `index.wxml`：标签文件，类似html
    - `index.wxss`：样式文件，类似css
    - `index.js`：脚本文件
    - `index.json`：配置文件
- `utils`：业务目录
- `app.js`：入口文件
- `app.json`：全局配置文件
- `app.wxss`：全局样式文件
- `project.config.json`：项目配置文件
- `sitemap.json`：微信索引配置文件

### 1.2 全局配置文件`app.json`

#### 1.2.1 entryPagePath（首页路径）

```json
{
  "entryPagePath": "pages/logs/logs",
  "pages": [
    "pages/index/index",
    "pages/logs/logs"
  ],
}

```

此时首页为 `pages/logs/logs`

#### 1.2.2 pages（页面路径列表）

- 数组形式
- 如果没有 `entryPagePath` 字段，开头第一个默认为首页

```json
{
  "pages": [
    "pages/index/index",
    "pages/logs/logs"
  ],
}
```

此时首页为 `pages/index/index`

#### 1.2.3 window（全局的默认窗口表现）

- `navigationBarBackgroundColor`：导航栏背景颜色，默认`#000000`
- `navigationBarTextStyle`：导航栏标题颜色，仅支持 `black` / `white`

- `navigationBarTitleText`：导航栏标题文字内容

- `navigationStyle`：导航栏样式，
  - 默认`default`
  
  - `custom` 去除默认导航栏，自定义导航栏，只保留右上角胶囊按钮。
  
- `enablePullDownRefresh`：开启全局的下拉刷新。，默认`false`

- `backgroundColor`：下拉刷新时窗口的背景色，只支持16进制

- `backgroundTextStyle`：下拉 loading 的样式，仅支持 `dark` / `light`

- `onReachBottomDistance`：页面上拉触底事件触发时距页面底部距离，单位为 `px`。
- `pageOrientation`：
  - auto：默认
  - portrait：
  - landscape：

- `backgroundColorTop`：顶部窗口的背景色，仅 iOS 支持
- `backgroundColorBottom`：底部窗口的背景色，仅 iOS 支持

#### 1.2.4 restartStrategy（[重新启动策略](https://developers.weixin.qq.com/miniprogram/dev/framework/runtime/operating-mechanism.html#_2-1-重新启动策略)配置）

- `homePage`：默认值，如果从这个页面退出小程序，下次将从首页冷启动
- `homePageAndLatestPage`：如果从这个页面退出小程序，下次冷启动后立刻加载这个页面，页面的参数保持不变（不可用于 tab 页）

#### 1.2.5 tabBar（导航栏）

- `color`：tab 上的文字默认颜色，仅支持十六进制颜色

- `selectedColor`：tab 上的文字选中时的颜色，仅支持十六进制颜色

- `backgroundColor`：tab 的背景色，仅支持十六进制颜色

- `borderStyle`：tabbar 上边框的颜色， 仅支持 `black` / `white`

- `list`：tab 的列表，详见 `list` 属性说明，最少 2 个、最多 5 个 tab

  - `pagePath`：页面路径，必须在 pages 中先定义
  - `text`：tab 上按钮文字
  - `iconPath`：图片路径，icon 大小限制为 40`kb`，建议尺寸为 81`px` * 81`px`，不支持网络图片。
  - `selectedIconPath`：选中时的图片路径，icon 大小限制为 40`kb`，建议尺寸为 81`px` * 81`px`，不支持网络图片。

- `position`：tabBar 的位置，仅支持 `bottom` / `top`

  - 注：为top时，图标默认不展示

- `custom`：自定义

  ```json
  {
    "tabBar": {
      "custom": true,
      "color": "#000000",
      "selectedColor": "#000000",
      "backgroundColor": "#000000",
      "list": [{
        "pagePath": "page/component/index",
        "text": "组件"
      }, {
        "pagePath": "page/API/index",
        "text": "接口"
      }]
    },
    "usingComponents": {}
  }
  ```



```json
{
    "tabBar": {
        "selectedColor": "1296db",
        "list": [
            {
                "pagePath": "pages/home/home",
                "text": "首页",
                "iconPath": "icon/home.png",
                "selectedIconPath": "icon/_home.png"
            },
            {
                "pagePath": "pages/img/img",
                "text": "图片",
                "iconPath": "icon/img.png",
                "selectedIconPath": "icon/_img.png"
            },
            {
                "pagePath": "pages/search/search",
                "text": "首页",
                "iconPath": "icon/search.png",
                "selectedIconPath": "icon/_search.png"
            },
            {
                "pagePath": "pages/my/my",
                "text": "图片",
                "iconPath": "icon/my.png",
                "selectedIconPath": "icon/_my.png"
            }
        ]
    },
}
```

#### 1.2.6 请求超时的时间（`networkTimeout`）

- `request`：[wx.request](https://developers.weixin.qq.com/miniprogram/dev/api/network/request/wx.request.html) 的超时时间，单位：毫秒。默认`60000`
- `connectSocket`：[wx.connectSocket](https://developers.weixin.qq.com/miniprogram/dev/api/network/websocket/wx.connectSocket.html) 的超时时间，单位：毫秒。
- `uploadFile`：[wx.uploadFile](https://developers.weixin.qq.com/miniprogram/dev/api/network/upload/wx.uploadFile.html) 的超时时间，单位：毫秒。
- `downloadFile`：[wx.downloadFile](https://developers.weixin.qq.com/miniprogram/dev/api/network/download/wx.downloadFile.html) 的超时时间，单位：毫秒。

## 2. 模板语法

- `text`：相当于 `span`
- `view`：相当于 `div`
- `checkboc`：复选框
- `block`：不会渲染成真实的DOM节点

### 2.1 数据绑定

- 简单绑定

  ```html
  <view>{{ msg }}</view>
  ```

  ```js
  Page({
    data: {
      msg: 'hello world'
    }
  })
  ```

- 复选框属性绑定

  ```html
  <checkbox value="" color="red" checked="{{ false }}" disabled="{{ false }}">
      
  </checkbox>
  ```

  - `color`：控制对勾的颜色
  - `checked`：是否被选中
  - `disabled`：是否禁用

### 2.2 简单运算

- 加减乘除：+，-，*，/，%
- 字符串拼接
- 三元表达式

### 2.3 列表渲染

可以遍历数据和对象

```html
<view
	wx:for="{{ arr }}"
    wx:for-item="item"
    wx:for-index="index"
    wx:key=""
>
	{{ index }} ---- {{ item }}
</view>
```

- `wx:for="{{ arr }}"`：要循环的数组或对象
- `wx:for-item="item"`：循环项，默认为 `item`
- `wx:for-index="index"`：循环索引，默认为 `index`
- `wx:key=""`：循环的key

#### 2.3.1 循环数组

```html
<view wx:for="{{ arr }}" wx:key="*this">
    {{ item }}
</view>
```

```js
Page({
    data: {
        arr: ['hello world',   'hello',   'world']
    },
})
```

循环数组普通数组时，可用`*this`

#### 2.3.2 循环对象

```html
<view wx:for="{{ obj }}" wx:for-item="value" wx:for-index="key" wx:key="key">
    {{ key }}: {{ value }}
</view>
```

```js
Page({
    data: {
        obj: {
            name: 'mie',
            age: 12,
            hobby: '篮球'
        }
    },
})
```

### 2.4 条件渲染

- `wx:if=""`
- `wx:elif=""`
- `wx:else`
- `hidden`

## 3. 事件绑定

先上个小demo

```html
<input value="{{ num }}" bindinput="handleInput" type="text"/>
<button bindtap="handleClick" data-add="-1">-</button>
<button bindtap="handleClick" data-add="+1">+</button>
{{ num }}
```

```js
Page({
  data: {
    num: 0
  },

  handleInput(e) {
    console.log(e.detail.value)
    this.setData({
      num: e.detail.value
    })
  },

  handleClick(e) {
    const key = e.target.dataset.add
    if(key === '-1') {
      this.setData({
        num: this.data.num + 1
      })
    } else {
      this.setData({
        num: this.data.num - 1
      })
    }
  }
})
```

- 事件命名：关键词 `bind` 加事件类型

  `bindinput`：input事件

  `bindtap`：click事件

- 函数传参：

  不能通过函数调用的形式来传参，需要通过自定义属性来传递参数，自定义属性以`data-`作为前缀，可以用过事件对象`e.target.dataset.xxx`来获取属性的值作为参数

- 修改值的方式：

  ```js
  this.setData({
      num: e.detail.value
  })
  ```

  通过对象的形式来修改data中的值



## 4. 样式（wxss）

### 4.1 单位（rpx）

`WXSS` (`WeiXin Style Sheets`)是一套样式语言，用于描述 `WXML` 的组件样式。

`rpx`（responsive pixel）: 可以根据屏幕宽度进行自适应。规定屏幕宽为`750rpx`。如在` iPhone6` 上，屏幕宽度为`375px`，共有750个物理像素，则`750rpx = 375px = 750`物理像素，`1rpx = 0.5px`物理像素。

### 4.2 引入

- 语法：`@import`
- 只支持相对路径

```css
@import '../../styles/global.wxss';
```

### 4.3 less应用

vsCode插件：easy less

```json
"less.compile": {
    "outExt": ".wxss"
}
```

img.less

```less
@import '../../styles/global.wxss';
@fontSize: 100rpx;
view {
    width: 100px;
    height: 100px;
    text {
        color: blue;
        font-size: @fontSize;
    }
}
```

img.wxss

```css
view {
  width: 200rpx;
  height: 200rpx;
  color: #fff;
  background: #000;
  border: 1px solid red;
  font-size: 80rpx;
  font-family: '微软雅黑';
}
view {
  width: 100px;
  height: 100px;
}
view text {
  color: blue;
  font-size: 100rpx;
}
```

## 5. 常见组件

### 5.1 视图容器

#### 5.1.1 view

视图容器，类似于div

属性：

- `hover-class`：指定按下去的样式类。当 `hover-class="none"` 时，没有点击态效果
- `hover-start-time`：按住后多久出现点击态，单位毫秒，默认50
- `hover-stay-time`：手指松开后点击态保留时间，单位毫秒，默认400

- `hover-stop-propagation`：阻止冒泡，默认为true      

#### 5.1.2 swiper

滑块视图容器。其中只可放置[swiper-item](https://developers.weixin.qq.com/miniprogram/dev/component/swiper-item.html)组件，否则会导致未定义的行为。

默认宽度100%，高度150px

##### 属性：

- `indicator-dots`：是否显示面板指示点，默认false
- `indicator-color`：指示点颜色
- `indicator-active-color`：当前选中的指示点颜色
- `autoplay`：自动轮播
- `current`：当前所在滑块的 index
- `interval`：轮播间隔时长
- `duration`：轮播切换时长
- `circular`：是否采用衔接滑动
- `vertical`：滑动方向是否为纵向
- `previous-margin`：前边距，可用于露出前一项的一小部分，接受 px 和 rpx 值
- `next-margin`：后边距，可用于露出后一项的一小部分，接受 px 和 rpx 值
- `snap-to-edge`：当 swiper-item 的个数大于等于 2，关闭 circular 并且开启 previous-margin 或 next-margin 的时候，可以指定这个边距是否应用到第一个、最后一个元素
- `display-multiple-items`：同时显示的滑块数量
- `easing-function`：指定 swiper 切换缓动动画类型
  - `default`：默认缓动函数
  - `linear`：线性动画
  - `easeInCubic`：缓入动画
  - `easeOutCubic`：缓出动画
  - `easeInOutCubic`：缓入缓出动画

##### 事件

- `bindchange`：current 改变时会触发 change 事件
- `bindtransition`：swiper-item 的位置发生改变时会触发 transition 事件
- `bindanimationfinish`：动画结束时会触发 animationfinish 事件

#### 5.1.3 share-element



#### 5.1.4 scroll-view

可滚动视图区域

- `scroll-x`：允许横向滚动
- `scroll-y`：允许纵向滚动
- `upper-threshold`：距顶部/左边多远时，触发 scrolltoupper 事件
- `lower-threshold`：距底部/右边多远时，触发 scrolltolower 事件
- `scroll-top`：设置竖向滚动条位置
- `scroll-left`：设置横向滚动条位置

#### 5.1.5 page-container



#### 5.1.6 movable-view



#### 5.1.7 movable-area



#### 5.1.8 match-media



#### 5.1.9 cover-view



#### 5.1.10 cover-image



### 5.2 基础内容

#### 5.2.1 text

- 文本标签，类似于span
- 里面只能嵌套text
- 长按文字可以复制
- 标签中可以识别空格，换行

属性：

- `selectable`：文本是否可选，默认false
- `space`：显示连续空格
- `decode`：是否解析编码，默认false

#### 5.2.2 rich-text

富文本标签

##### 属性

- `nodes`：节点列表/HTML String

  - 支持字符串

  - 支持数组，类似虚拟dom

    **元素节点：type = node**

    | 属性     | 说明       | 类型   | 必填 | 备注                                     |
    | -------- | ---------- | ------ | ---- | ---------------------------------------- |
    | name     | 标签名     | string | 是   | 支持部分受信任的 HTML 节点               |
    | attrs    | 属性       | object | 否   | 支持部分受信任的属性，遵循 Pascal 命名法 |
    | children | 子节点列表 | array  | 否   | 结构和 nodes 一致                        |

    **文本节点：type = text**

    | 属性 | 说明 | 类型   | 必填 | 备注         |
    | ---- | ---- | ------ | ---- | ------------ |
    | text | 文本 | string | 是   | 支持entities |

- `space`：显示连续空格

#### 5.2.3 icon

图标

##### 属性

- `type`：icon的类型
- `size`：icon大小，默认23px
- `color`：颜色

### 5.3 表单组件

#### 5.3.1 button

按钮。

##### 属性

- `size`：默认`default`，还有mini
- `typ`e：默认`default`，还有`primary`，`warn`
- `plain`：按钮是否镂空，背景色透明，默认false
- `disabled`：是否禁用，默认false
- `loading`：是否loading，默认false
- `form-type`：用于 [form](https://developers.weixin.qq.com/miniprogram/dev/component/form.html) 组件，点击分别会触发 [form](https://developers.weixin.qq.com/miniprogram/dev/component/form.html) 组件的 submit/reset 事件
  - `submit`：提交表单
  - `reset`：重置表单
- `hover-class`：指定按钮按下去的样式类
- `hover-stop-propagation`：阻止冒泡
- `lang`：指定返回用户信息的语言
  - `en`：英文
  - `zh_CN`：简体中文
  - `zh_TW`：繁体中文
- `open-type`：微信开放能力
  - `contact`：打开客服会话
    - `bindcontact`：客服消息回调
  - `share`：触发用户转发
  - `getPhoneNumber`：获取用户手机号
    - `bindgetphonenumber`：获取用户手机号回调
  - `getUserInfo`：获取用户信息
    - `bindgetuserinfo`：用户点击该按钮时，会返回获取到的用户信息
  - `launchApp`：打开app
  - `openSetting`：打开授权设置页
    - `bindopensetting`：在打开授权设置页后回调
  - `feedback`：用户建议反馈
  - `chooseAvatar`：获取用户头像
    - `bindchooseavatar`：获取用户头像回调

#### 5.3.2 radio

- 单选框
- 需要嵌套在`radio-group`中使用

##### `radio-group`事件

- `bindchange`：[radio-group](https://developers.weixin.qq.com/miniprogram/dev/component/radio-group.html)中选中项发生改变时触发 change 事件，detail = {value:[选中的radio的value的数组]}

##### `radio`属性

- `value`：[radio](https://developers.weixin.qq.com/miniprogram/dev/component/radio.html) 标识。当该[radio](https://developers.weixin.qq.com/miniprogram/dev/component/radio.html) 选中时，[radio-group](https://developers.weixin.qq.com/miniprogram/dev/component/radio-group.html) 的 change 事件会携带[radio](https://developers.weixin.qq.com/miniprogram/dev/component/radio.html)的value
- `checked`：当前是否选中
- `disabled`：是否禁用
- `color`：颜色

#### 5.3.3 checkbox

- 复选框
- 配合`checkbox-group`来使用

##### `checkbox-group`事件

- `bindchange`：[checkbox-group](https://developers.weixin.qq.com/miniprogram/dev/component/checkbox-group.html)中选中项发生改变时触发 change 事件，detail = {value:[选中的checkbox的value的数组]}

##### `checkbox`属性

- `value`：选中的值
- `disabled`：是否禁用
- `checked`：当前是否选中
- `color`：颜色

### 5.4 导航组件

#### 5.4.1 navigator

- 页面链接
- 块状元素，默认换行

##### 属性

- `target`：在哪个目标上发生跳转，默认当前小程序
  - `self`：当前小程序
  - `miniProgram`：其它小程序
- `url`：链接地址
- `open-type`：跳转方式
  - `navigate`：留当前页面，跳转到应用内的某个页面。但是不能跳到 tabbar 页面，对应 [wx.navigateTo](https://developers.weixin.qq.com/miniprogram/dev/api/route/wx.navigateTo.html) 或 [wx.navigateToMiniProgram](https://developers.weixin.qq.com/miniprogram/dev/api/navigate/wx.navigateToMiniProgram.html) 的功能
  - `redirect`：关闭当前页面，跳转到应用内的某个页面。但是不允许跳转到 tabbar 页面，对应 [wx.redirectTo](https://developers.weixin.qq.com/miniprogram/dev/api/route/wx.redirectTo.html) 的功能
  - `switchTab`：跳转到 tabBar 页面，并关闭其他所有非 tabBar 页面，对应 [wx.switchTab](https://developers.weixin.qq.com/miniprogram/dev/api/route/wx.switchTab.html) 的功能
  - `reLaunch`：关闭所有页面，打开到应用内的某个页面，对应 [wx.reLaunch](https://developers.weixin.qq.com/miniprogram/dev/api/route/wx.reLaunch.html) 的功能
  - `navinavigateBackgate`：关闭当前页面，返回上一页面或多级页面，对应 [wx.navigateBack](https://developers.weixin.qq.com/miniprogram/dev/api/route/wx.navigateBack.html) 的功能
  - `exit`：退出其他小程序，`target="miniProgram"`时生效

### 5.5 媒体组件

#### 5.5.1 image

- 支持 JPG、PNG、SVG、WEBP、GIF 等格式
- image组件存在默认宽高：宽320px，高240px

##### 属性

- `src`：图片资源地址
- `mode`：图片裁剪、缩放的模式，决定图片内容，宽高的适配
  - `scaleToFill`：默认值，不保持宽高比
  - `aspectFit`：保持纵横比缩放图片，以长边为准，短边部分图片居中，可完整展示图片
  - `aspectFill`：保持纵横比缩放图片，以短边为准，长边部分图片居中，不可完整展示图片
  - `widthFix`：设置宽，高度随比例变化
  - `heightFix`：设置高，宽度随比例变化
  - `top`：不缩放图片，图片位置居上
  - `bottom`：不缩放图片，图片位置居下
  - `center`：不缩放图片，图片位置居中
  - `left`：不缩放图片，图片位置居左
  - `top left`：不缩放图片，图片位置居左上
  - `top right`：不缩放图片，图片位置居右上
  - `bottom left`：不缩放图片，图片位置居左下
  - `bottom right`：不缩放图片，图片位置居右下
- `webp`：默认不解析 webP 格式，只支持网络资源
- `lazy-load`：图片懒加载，在即将进入一定范围（上下三屏）时才开始加载
- `show-menu-by-longpress`：默认false，长按图片显示发送给朋友、收藏、保存图片、搜一搜、打开名片/前往群聊/打开小程序（若图片中包含对应二维码或小程序码）的菜单。支持识别的码：小程序码 仅小程序支持识别的码：微信个人码、微信群码、企业微信个人码、 企业微信群码与企业微信互通群码；

##### 事件

- `binderror`：当错误发生时触发
- `bindload`：当图片载入完毕时触发

```html
<image class="" src="/images/abc.jpg" show-menu-by-longpress binderror="imgErr" bindload="imgSuccess"
```

```js
Page({
  imgErr() {
    console.log('加载失败')
  },
  imgSuccess() {
    console.log('加载成功')
  }
})
```

### 5.6 地图



### 5.7 画布



## 6. 自定义组件

类似于页面，一个自定义组件由 `json` `wxml` `wxss` `js` 4个文件组成。要编写一个自定义组件，首先需要在 `json` 文件中进行自定义组件声明（将 `component` 字段设为 `true` 可将这一组文件设为自定义组件）

### 6.1 自定义组件使用

- 在组件文件中添加 `{component:true}` 

- 父组件配置文件中添加 `{"usingComponents": {"conponent-tabs": "/components/tabs/tabs"}}` 
- 父级中就可以使用了`<conponent-tabs list="{{list}}" />`

### 6.2 Component构造器

`Component` 构造器可用于定义组件，调用 `Component` 构造器时可以指定组件的属性、数据、方法等。

详细的参数含义和使用请参考 [Component 参考文档](https://developers.weixin.qq.com/miniprogram/dev/reference/api/Component.html)。

属性：

- `properties`：接收父组件的传值
- `data`：组件内部变量
- `observers`：监听变量变化，语watch类似
- `methods`：组件的方法容器
- `behaviors`：混入
- `options`：配置项，可配置是否支持多个插槽等

生命周期：

- `created`：组件实例刚创建时执行，此时不能调用 `setData`
- `attached`：在组件实例进入页面节点树时执行
- `ready`：组件布局完成后执行
- `moved`：在组件实例被移动到节点树另一个位置时执行
- `detached`：组件被销毁是执行
- `data`：

| 定义段           | 类型         | 是否必填 | 描述                                                         | 最低版本                                                     |
| :--------------- | :----------- | :------- | :----------------------------------------------------------- | :----------------------------------------------------------- |
| properties       | Object Map   | 否       | 组件的对外属性，是属性名到属性设置的映射表                   |                                                              |
| data             | Object       | 否       | 组件的内部数据，和 `properties` 一同用于组件的模板渲染       |                                                              |
| observers        | Object       | 否       | 组件数据字段监听器，用于监听 properties 和 data 的变化，参见 [数据监听器](https://developers.weixin.qq.com/miniprogram/dev/framework/custom-component/observer.html) | [2.6.1](https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html) |
| methods          | Object       | 否       | 组件的方法，包括事件响应函数和任意的自定义方法，关于事件响应函数的使用，参见 [组件间通信与事件](https://developers.weixin.qq.com/miniprogram/dev/framework/custom-component/events.html) |                                                              |
| behaviors        | String Array | 否       | 类似于mixins和traits的组件间代码复用机制，参见 [behaviors](https://developers.weixin.qq.com/miniprogram/dev/framework/custom-component/behaviors.html) |                                                              |
| created          | Function     | 否       | 组件生命周期函数-在组件实例刚刚被创建时执行，注意此时不能调用 `setData` ) |                                                              |
| attached         | Function     | 否       | 组件生命周期函数-在组件实例进入页面节点树时执行)             |                                                              |
| ready            | Function     | 否       | 组件生命周期函数-在组件布局完成后执行)                       |                                                              |
| moved            | Function     | 否       | 组件生命周期函数-在组件实例被移动到节点树另一个位置时执行)   |                                                              |
| detached         | Function     | 否       | 组件生命周期函数-在组件实例被从页面节点树移除时执行)         |                                                              |
| relations        | Object       | 否       | 组件间关系定义，参见 [组件间关系](https://developers.weixin.qq.com/miniprogram/dev/framework/custom-component/relations.html) |                                                              |
| externalClasses  | String Array | 否       | 组件接受的外部样式类，参见 [外部样式类](https://developers.weixin.qq.com/miniprogram/dev/framework/custom-component/wxml-wxss.html) |                                                              |
| options          | Object Map   | 否       | 一些选项（文档中介绍相关特性时会涉及具体的选项设置，这里暂不列举） |                                                              |
| lifetimes        | Object       | 否       | 组件生命周期声明对象，参见 [组件生命周期](https://developers.weixin.qq.com/miniprogram/dev/framework/custom-component/lifetimes.html) | [2.2.3](https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html) |
| pageLifetimes    | Object       | 否       | 组件所在页面的生命周期声明对象，参见 [组件生命周期](https://developers.weixin.qq.com/miniprogram/dev/framework/custom-component/lifetimes.html) | [2.2.3](https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html) |
| definitionFilter | Function     | 否       | 定义段过滤器，用于自定义组件扩展，参见 [自定义组件扩展](https://developers.weixin.qq.com/miniprogram/dev/framework/custom-component/extend.html) | [2.2.3](https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html) |

### 6.3 父子组件之间的传值

和vue父子组件之间的传值类似

#### 6.3.1 父传子

- 父组件通过属性传值
- 子组件通过`properties`属性接收

通过属性传值

父组件`search.wxml`

```html
<conponent-tabs list="{{list}}" />
```

子组件`tabs.js`

```js
Component({
    properties: {
        list: {
            type: Array,
            default: []
        }
    }
})
```

#### 6.3.2 子传父

- 子组件通过事件来传值`this.triggerEvent('deleteItem', index)`
- 父组件用过事件来接收``

子组件`tabs.js`

```js
Component({
  properties: {
    list: {
      type: Array,
      default: []
    }
  },
  methods: {
    delete(e) {
      let index = e.target.dataset.index
      this.triggerEvent('deleteItem', index)
    }
  }
})
```

父组件`search.wxml`

```html
<conponent-tabs list="{{list}}" bind:deleteItem="deleate" />
<!--<conponent-tabs list="{{list}}" binddeleteItem="deleate" />-->
```

子组件`search.js`

```js
Page({
  data: {
    list: [
      {
        name: 'mary',
        age: 12
      },
      {
        name: 'bob',
        age: 20
      }
    ]
  },
  deleate(e) {
    let index = e.detail
    this.data.list.splice(index, 1)
    this.setData({
      list: this.data.list
    })
  }
})
```



### 6.4 插槽slot

#### 6.4.1 默认插槽

```html
<conponent-tabs list="{{list}}">
    我是插槽
</conponent-tabs>
```

```html
<view>
    <view wx:for="{{list}}" bindtap="delete" data-index="{{ index }}" wx:key="*this">
        {{ item.name }} 今年 {{ item.age }} 岁了
    </view>
    <slot></slot>
</view>
```

#### 6.4.2 具名插槽

开启具名及多插槽

`tabs.js`

```js
Component({
  options: {
    multipleSlots: true
  }
})
```

父组件`search.wxml`

```html
<conponent-tabs list="{{list}}" bind:deleteItem="deleate">
    <view slot="before">
        我是插槽前
    </view>
      <view slot="">
        我是插槽时
    </view>
    <view slot="after">
        我是插槽后
    </view>
</conponent-tabs>
```

子组件`tabs.wxml`

```html
<view>
    <view wx:for="{{list}}" bindtap="delete" data-index="{{ index }}" wx:key="*this">
        {{ item.name }} 今年 {{ item.age }} 岁了
    </view>
    <slot></slot>
    <slot name="before"></slot>
    <slot name="after"></slot>
</view>
```



## 7. 生命周期

### 7.1 应用





### 7.2 页面



### 7.3 组件





## 8. 常用api

### 8.1 基础

#### 8.1.1 wx.env（环境变量）

wx.env

#### 8.1.2 wx.canIUse

判断当前版本，当前环境，某些方法是否实施支持

```js
wx.canIUse('alert'); // false
wx.canIUse('console.log'); // true
```

#### 8.1.3 wx.base64ToArrayBuffer

将base64字符串转化为ArrayBuffer对象

```js
const base64 = '11'
const arrayBuffer = wx.base64ToArrayBuffer(base64)
```

#### 8.1.4 wx.arrayBufferToBase64

将ArrayBuffer对象转化为base64字符串

### 8.2 系统

#### 8.2.1 wx.openSystemBluetoothSetting

跳转系统蓝牙设置页。仅支持安卓。

```js
wx.openSystemBluetoothSetting({
  success (res) {
    console.log(res)
  }
})
```

#### 8.2.2 wx.openAppAuthorizeSetting

跳转系统微信授权管理页

```js
wx.openAppAuthorizeSetting({
  success (res) {
    console.log(res)
  }
})
```

#### 8.2.3 getWindowInfo

获取窗口信息

```js
const windowInfo = wx.getWindowInfo()
```

- `pixelRatio`：设备像素比
- `screenWidth`：屏幕宽度，单位px
- `screenHeight`：屏幕高度，单位px
- `windowWidth`：可使用窗口宽度，单位px
- `windowHeight`：可使用窗口高度，单位px
- `statusBarHeight`：状态栏的高度，单位px
- `safeArea`： 在竖屏正方向下的安全区域
  - `left`：安全区域左上角横坐标
  - `right`：安全区域右下角横坐标
  - `top`：安全区域左上角纵坐标
  - `bottom`：安全区域右上角横坐标
  - `width`：安全区域的宽度，单位逻辑像素
  - `height`：安全区域的高度，单位逻辑像素
- `screenTop`：窗口上边缘的y值

#### 8.2.4 wx.getSystemSetting

```js
const systemSetting = wx.getSystemSetting()
```

- `bluetoothEnabled`：蓝牙的系统开关
- `locationEnabled`：地理位置的系统开关
- ` wifiEnabled`：Wi-Fi 的系统开关
- `deviceOrientation`：设备方向
  - `portrait`：竖屏
  - `landscape`：横屏

```js
const systemSetting = wx.getSystemSetting()
  wx.showToast({
    title: `蓝牙：${systemSetting.bluetoothEnabled}，WIFI：${systemSetting.wifiEnabled}，地理位置：${systemSetting.locationEnabled}，竖屏：${systemSetting.deviceOrientation}`,
    icon: 'none',
    duration: 5000,
})
```

#### 8.2.5 wx.getSystemInfo

获取系统信息，同步版本

```js
wx.getSystemInfo({
    success (res) {
        wx.showToast({
            title: res.brand,
            icon: 'none',
            duration: 5000,
        })
    }
})
```

- `brand`：品牌名称，vivo
- `model`：设备型号
- `language`：微信设置的语言，`zh_CN`
- `version`：微信版本号，`8.0.16`
- `system`：操作系统及版本，`Android11`
- `platform`：客户端平台，`Android` / `IOS`
- `fontSizeSetting`：用户字体大小（单位px）。以微信客户端「我-设置-通用-字体大小」中的设置为准

#### 8.2.6 wx.getSystemInfoAsync

同上

wx.getSystemInfo同上

#### 8.2.7 wx.getDeviceInfo

获取设备基础信息

```js
const deviceInfo = wx.getDeviceInfo()
console.log(deviceInfo)
```

- `abi`：应用二进制接口类型（仅 Android 支持）
- `benchmarkLevel`：设备性能等级（仅 Android 支持）。取值为：-2 或 0（该设备无法运行小游戏），-1（性能未知），>=1（设备性能值，该值越高，设备性能越好，目前最高不到50）
- `model`：设备型号
- `system`：操作系统及版本

#### 8.2.8 wx.getAppBaseInfo

获取微信APP基础信息

```js
const appBaseInfo = wx.getAppBaseInfo()
```

#### 8.2.9 wx.getAppAuthorizeSetting

获取微信APP授权设置

```js
const appAuthorizeSetting = wx.getAppAuthorizeSetting()
```

### 8.3 更新

#### 8.3.1 wx.updateWeChatApp

更新客户端版本。当判断用户小程序所在客户端版本过低时，可使用该接口跳转到更新微信页面。

```js
wx.updateWeChatApp({
    success: function(res) {
        console.log(res)
    }
})
```

#### 8.3.2 wx.getUpdateManager

同上

### 8.4 应用级事件

#### 8.4.1 wx.onUnhandledRejection



### 8.5 路由

#### 8.5.1 wx.switchTab

跳转到 tabBar 页面，并关闭其他所有非 tabBar 页面

参数：

- `url`：跳转的路径
- `success`：成功的回调
- `fail`：失败的回调
- `complete`：完成的回调

#### 8.5.2 wx.reLaunch

关闭所有页面，打开到应用内的某个页面，**可以是tabbar页面**

#### 8.5.3 wx.redirectTo

关闭当前页面，跳转到应用内的某个页面。但是**不允许跳转到 tabbar 页面**

#### 8.5.4 wx.navigateTo

保留当前页面，跳转到应用内的某个页面。但是**不能跳到 tabbar 页面**，小程序中页面栈最多十层

#### 8.5.5 navigateBack

关闭当前页面，返回上一页面或多级页面。可通过 [getCurrentPages](https://developers.weixin.qq.com/miniprogram/dev/reference/api/getCurrentPages.html) 获取当前的页面栈，决定需要返回几层。

参数：

- `delta`：返回的层数

- `success`：成功
- `fail`：失败
- `complete`：完成

### 8.6 转发

#### 8.6.1 wx.showShareImageMenu

打开分享图片弹窗，可以将图片发送给朋友、收藏或下载

参数： 

- `path`：要分享的图片地址，**必须为本地路径或临时路径**
- success：成功回调
- fail：失败回调
- complete：完成回调

#### 8.6.2 wx.shareVideoMessage

转发视频到聊天

- `videoPath`：要分享的视频地址，**必须为本地路径或临时路径**
- `thumbPath`：缩略图路径，若留空则使用视频首帧
- success：成功回调
- fail：失败回调
- complete：完成回调

#### 8.6.3 wx.shareFileMessage

转发文件到聊天

- `filePath`：要分享的文件地址，**必须为本地路径或临时路径**
- `fileName`：缩略图路径，若留空则使用视频首帧
- success：成功回调
- fail：失败回调
- complete：完成回调

#### 8.6.4 wx.onCopyUrl

监听用户点击右上角菜单的「复制链接」按钮时触发的事件



### 8.7 界面

#### 8.7.1 wx.showToast

显示消息提示框

参数：

- `title`：提示的内容
- `icon`：图标类型
  - `success`：显示成功图标，此时 title 文本最多显示 7 个汉字长度
  - `error`： 显示失败图标，此时 title 文本最多显示 7 个汉字长度
  - loading`：显示加载图标，此时 title 文本最多显示 7 个汉字长度
  - `none`： 不显示图标，此时 title 文本最多可显示两行
- `image`：自定义图标的**本地路径**，image 的优先级高于 icon
- `duration`：提示的延迟时间
- `mask`：是否显示透明蒙层，防止触摸穿透
- `success`：成功回调
- 。。。

关闭：wx.hideToast()

#### 8.7.2 wx.showModal

显示模态对话框

属性：

- `title`：提示标题
- `content`：提示内容
- `showCancel`：是否展示取消按钮
- `cancelText`：取消文字替换
- `cancelColor`：取消文字颜色
- `confirmText`：确认按钮文字
- `confirmColor`：确认按钮颜色
- `editable`：是否显示输入框
- `placeholderText`：输入框提示文本
- `success`：成功回调
- 。。。

#### 8.7.3 wx.showLoading

加载效果

参数：

- `title`：提示内容
- `mask`：是否显示透明
- `success`：成功回调
- 。。。

关闭：wx.hideLoading()

#### 8.7.4 wx.showActionSheet

显示选择菜单

参数：

- `alertText`：提示文字
- `itemList`：选项列表
- `itemColor`：选项文字颜色
- `success`：成功回调
- 。。。

### 8.8 导航栏

#### 8.8.1 wx.showNavigationBarLoading

在当前页面显示导航条加载动画

- `success`：成功回调
- 。。。

隐藏`loading`：`wx.hideNavigationBarLoading`

#### 8.8.2 wx.setNavigationBarTitle

动态设置当前页面的标题

参数：

- `title`： 页面标题
- `success`：成功回调
- 。。。

#### 8.8.3 wx.setNavigationBarColor

设置页面导航条颜色

参数：

- `frontColor·：前景颜色值，包括按钮、标题、状态栏的颜色，仅支持 #ffffff 和 #000000
- `backgroundColor`：背景颜色值，有效值为十六进制颜色
- `animation`：动画效果
  - `duration`：动画持续时间
  - `timingFunc`：动画变化方式
    - `linear`： 动画从头到尾的速度是相同的
    - `easeIn`： 动画以低速开始
    - `easeOut`：  动画以低速结束
    - `easeInOut`： 动画以低速开始和结束
- `success`：成功回调
- 。。。

#### 8.8.4 wx.hideHomeButton

隐藏返回按钮

### 8.9 背景

#### 8.9.1 wx.setBackgroundTextStyle

设置下拉loading样式

#### 8.9.2 wx.setBackgroundColor

动态设置窗口背景色

属性：

- `background`：窗口的背景色，必须为十六进制颜色值

- `backgroundColorTop`：顶部窗口的背景色，必须为十六进制颜色值，仅 iOS 支持
- `backgroundColorBottom`：底部窗口的背景色，必须为十六进制颜色值，仅 iOS 支持
- `success`：成功回调

### 8.10 tab bar

#### 8.10.1 wx.showTabBarRedDot

显示 tabBar 某一项的右上角的红点

参数：

- `index`：tabBar 的哪一项，从左边算起
- `success`：成功回调

隐藏：`wx.hideTabBarRedDot`

#### 8.10.2 wx.showTabBar

显示tab bar

参数：

- `animation`：是否需要动画效果
- `success`：成功回调
- 。。。

隐藏：`wx.hideTabBar`

#### 8.10.3 wx.setTabBarStyle

动态设置 tabBar 的整体样式

参数：

- color：tab 上的文字默认颜色
- selectedColor：选中的文字颜色
- backgroundColor：tab 的背景色
- borderStyle：tabBar上边框的颜色， 仅支持 black/white
- success：成功回调

#### 8.10.4 wx.setTabBarItem

设置某一项tab内容

属性：

- `index`：tabBar 的哪一项，从左边算起

- `text`：文字
- `iconPath`：图标路径
- `selectedIconPath`：选中后图标路径
- `success`：成功回调

#### 8.10.5 wx.setTabBarBadge

为 tabBar 某一项的右上角添加文本

参数：

- `index`：tabBar 的哪一项，从左边算起
- `text`：显示的文本，超过 4 个字符则显示成 ...
- `success`：成功回调

移除：`wx.removeTabBarBadge`

### 8.11 字体、下拉刷新、滚动

#### 8.11.1 wx.loadFontFace

动态加载网络字体，文件地址需为下载类型

- global
- family
- source
- 



#### 8.11.2 wx.startPullDownRefresh

开始下拉刷新。调用后触发下拉刷新动画，效果与用户手动下拉刷新一致。

停止：`wx.stopPullDownRefresh`

#### 8.11.3 wx.pageScrollTo

将页面滚动到目标位置，支持选择器和滚动距离两种方式定位

属性：

- `scrollTop`：滚动到页面的目标位置，单位 px
- `duration`：滚动动画的时长，单位 ms
- `selector`：选择器
- `success`：成功回调

### 8.12 动画







# 二、骨架屏

- 微信开发者工具右下角`...`，生成骨架屏

- index.wxml

  ```html
  <import src="index.skeleton.wxml" />
  <template is="skeleton" wx:if="{{ isLoad }}" />
  ```

- index.wxss

  ```css
  @import './index.skeleton.wxss';
  ```

- 根据请求状态，显示隐藏骨架屏









# 三、电商案例

接口文档：https://www.showdoc.com.cn/128719739414963

### 1. 项目搭建 

#### 1.1 框架介绍

- 腾讯：wepy，类似vue
- 美团：mpvue，类似vue
- 京东：taro，类似react
- 滴滴：chameleon
- uni-app：，类似vue
- 原生：mina

#### 1.2 项目搭建

##### 1.2.1项目目录

- pages：页面文件
  - 首页：home
  - 分类：category
  - 购物车：shopcar
  - 我的：my
- styles：样式文件
- utils：业务处理文件
- lib：包文件
- components：组件
- icon：字体图标
- app.js：全局js文件
- app.wxss：全局样式文件
- app.json：全局配置文件
- project.config.json：项目配置文件
- sitemap.json：搜索配置文件

app.json

```json
{
  "pages":[
    "pages/home/index",
    "pages/category/index",
    "pages/shopcar/index",
    "pages/my/index",
    "pages/index/index"
  ],
  "window":{
    "backgroundTextStyle":"dark",
    "navigationBarBackgroundColor": "#F8554D",
    "navigationBarTitleText": "我的购物网站",
    "navigationBarTextStyle":"white",
    "enablePullDownRefresh": true,
    "backgroundColor": "#F5F5F5"
  },
  "tabBar": {
    "color": "#8a8a8a",
    "selectedColor": "#FC011A",
    "list": [
      {
        "pagePath": "pages/home/index",
        "text": "首页",
        "iconPath": "/icon/home.png",
        "selectedIconPath": "/icon/home_avtive.png"
      },
      {
        "pagePath": "pages/category/index",
        "text": "分类",
        "iconPath": "/icon/caidan.png",
        "selectedIconPath": "/icon/caidan_avtive.png"
      },
      {
        "pagePath": "pages/shopcar/index",
        "text": "购物车",
        "iconPath": "/icon/gouwuche.png",
        "selectedIconPath": "/icon/gouwuche_avtive.png"
      },
      {
        "pagePath": "pages/my/index",
        "text": "我的",
        "iconPath": "/icon/wode.png",
        "selectedIconPath": "/icon/wode_avtive.png"
      }
    ]
  },
  "style": "v2",
  "sitemapLocation": "sitemap.json"
}
```

##### 1.2.2 请求接口域名配置

微信公众平台 ---> 开发 ---> 开发管理 ---> 开发设置 ---> 服务器域名

#### 1.3 封装请求方法

utils/request.js

```js
export const request = params => {
    const baseUrl = 'https://api-hmugo-web.itheima.net/api/public/v1'
    return new Promise((resolve, reject) => {
        wx.request({
            ...params,
            url: baseUrl + params.url,
            success: res => {
                resolve(res)
            },
            fail: error => {
                reject(error)
            }
        })
    })
}
```

引用

```js
import { request } from '../../request'
```

#### 1.4 小程序less用法

- vsCode插件`Easy LESS`

- 打开 `settings.json` 文件

  ```json
  {
      "less.compile": {
          "outExt": ".wxss"
      },
  }
  ```

#### 1.5 CSS Tree

- vsCode插件`CSS Tree`
- ctrl + g  ===>  `>css tree`

### 2. 首页

<img style="width: 40%" src="./img/home.png" />

home/index.wxml

```html
<view class="home">
    <!-- 搜索按钮 -->
    <search-btn />

    <!-- 首页轮播 -->
    <swiper class="home-swiper" autoplay circular indicator-dots="false">
        <swiper-item wx:for="{{ swiperList }}" class="home-swiper-item" wx:key="goods_id">
            <navigator class="" target="" url="{{ '../good_detail/index?id=' + item.goods_id }}" hover-class="navigator-hover" open-type="navigate">
                <image class="" src="{{ item.image_src}}" mode="widthFix" />
            </navigator>
        </swiper-item>
    </swiper>

    <!-- 首页导航标签 -->
    <view class="home-nav-list">
        <image class="home-nav-item" mode="widthFix" wx:for="{{ navList }}" wx:key="name" src="{{ item.image_src }}"></image>
    </view>

    <!-- 首页分类 -->
    <view class="home-floor-list">
        <view class="home-floor-item" wx:for="{{ floorList }}" wx:key="name">
            <image class="home-floor-title" src="{{ item.floor_title.image_src }}" mode="widthFix" />
            <view class="home-floor-content">
                <navigator class="home-floor-content-nav"
                    wx:for="{{ item.product_list }}"
                    wx:for-item="item1"
                    wx:key="name"
                    url="{{ '../good_list/index?query=' + item1.name }}"
                    hover-class="navigator-hover"
                    open-type="{{ item1.open_type }}"
                >   
                    <image class="home-floor-content-img" src="{{ item1.image_src }}" mode="" lazy-load/>
                </navigator>
            </view>
        </view>
    </view>
</view>
```

home/index.js

```js
// pages/home/index.js
import { request } from '../../utils/request'
Page({
  data: {
    swiperList: [],
    navList: [],
    floorList: []
  },

  /**
   * 生命周期函数--监听页面加载
   */
  onLoad: function (options) {
    this.getSwiperList()
    this.getNavList()
    this.getFloorList()
  },

  // 获取轮播图
  async getSwiperList() {
    const { data } = await request({
      url: '/home/swiperdata'
    })
    if(data.meta.status === 200) {
      this.setData({
        swiperList: data.message
      })
    }
  },

  // 获取首页导航
  async getNavList() {
    const { data } = await request({
      url: '/home/catitems'
    })
    if(data.meta.status === 200) {
      this.setData({
        navList: data.message
      })
    }
  },

  // 获取分类列表
  async getFloorList() {
    const { data } = await request({
      url: '/home/floordata'
    })
    const { message } = data
    message.forEach(item => {
      item.product_list.forEach(item1 => {
        item1.name = item1.navigator_url.split('=')[1]
      })
    })
    if(data.meta.status === 200) {
      this.setData({
        floorList: message
      })
    }
  }
})
```

### 3. 分类

<img style="width: 40%" src="./img/category.png" />

category/index.html

```html
<!-- 引入骨架屏 -->
<import src="index.skeleton.wxml" />
<!-- 使用骨架屏模板 -->
<template is="skeleton" wx:if="{{ isLoad }}" />
<view class="category">
    <!-- 搜索 -->
    <block hidden>
        <search-btn />
    </block>

    <!-- 分类 -->
    <!-- 一级分类 左 -> 右 -->
    <view class="category-content">
        <view class="category-left-wrap">
            <scroll-view class="category-left" scroll-y>
                <view
                    class="cat_level-0 {{ index == current_active ? 'active' : ''}}"
                    wx:for="{{ categoryList_left }}"
                    wx:key="cat_id"
                    bindtap="handleClick"
                    data-index="{{ index }}"
                >
                    {{ item.cat_name }}
                </view>
            </scroll-view>
         </view>
        <!-- 二级分类 上 -> 下 -->
        <view class="category-right-wrap">
            <category-item
                categoryList="{{ categoryList[current_active] }}"
            />
        </view>
    </view>
</view>
```

category/index.js

```js
import { request } from '../../utils/request'
Page({
  data: {
    categoryList: [],
    categoryList_left: [],
    current_categoryList: {},
    current_active: 0,
    isLoad: true
  },

  /**
   * 生命周期函数--监听页面加载
   */
  onLoad: function (options) {
    this.getCategoryList()
  },

  async getCategoryList() {
    const { data } = await request({
      url: '/categories'
    })
    if(data.meta.status === 200) {
      const { message } = data
      let cat_level = []
      message.forEach(item => {
        cat_level.push({
          cat_deleted: item.cat_deleted,
          cat_icon: item.cat_icon,
          cat_id: item.cat_id,
          cat_level: item.cat_level,
          cat_name: item.cat_name,
          cat_pid: item.cat_pid
        })
      })
      this.setData({
        categoryList: data.message,
        categoryList_left: cat_level,
        current_categoryList: data.message[0],
        isLoad: false
      })
    }
  },

  handleClick(data) {
    const current = data.currentTarget.dataset.index
    this.setData({
      current_active: current,
      current_categoryList: this.data.categoryList[current]
    })
  }
})
```



category-item/index.wxml

```html
<view class="category-item">
    <scroll-view class="category-right" scroll-y>
        <view class="view">
            <view
                class="category-right-containt"
                wx:for="{{ categoryList.children }}"
                wx:key="cat_id"
            >
                <view class="category-right-title">
                    {{ item.cat_name }}
                </view>
                <view class="category-right-list">
                    <navigator
                        class=""
                        wx:for="{{ item.children }}"
                        wx:for-item="item1"
                        wx:key="cat_id"
                        url="{{ '../../pages/good_list/index?query=' + item1.cat_name }}"
                        open-type="navigate"
                    >
                        <view class="img-wrap">
                            <image class="cat_icon" src="{{ item1.cat_icon }}" mode="aspectFit"/>
                        </view>
                        <text class="cat_name">{{ item1.cat_name }}</text>
                    </navigator>
                </view>
            </view>
        </view>
    </scroll-view>
</view>
```

category-item/index.js

```js
Component({
  properties: {
    categoryList: {
      type: Object,
      default: {}
    }
  },
})
```



- `less`中的`calc`计算，`height: ~'calc(100% - 105rpx)';`

### 4. 商品列表

<img style="width: 40%" src="./img/goods_list.png" />

good_list/index.wxml

```html
<view class="good-list-wrap">
    <search-btn />
    <scroll-view class="good-list" scroll-y enhanced show-scrollbar="false">
        <navigator
            class="good-item"
            wx:for="{{ goodList }}"
            wx:key="goods_id"
            url="../good_detail/index?id={{ item.goods_id }}"
            open-type="navigate"
        >
            <image class="good-item-cover" src="{{ item.goods_small_logo || 'https://ww1.sinaimg.cn/large/007rAy9hgy1g24by9t530j30i20i2glm.jpg' }}" mode="widthFix" lazy-load="false" binderror="" bindload="" />
            <view class="good-name">{{ item.goods_name }}</view>
            <view class="good-price">￥{{ item.goods_price }}</view>
            <view class="good-number">库存{{ item.goods_number }}件</view>
        </navigator>
          
    </scroll-view>
    <view class="loading" wx:if="{{ isDownLoad }}">
        正在加载中...
    </view>
    <view class="has-no" wx:else>
        没有更多了~
    </view>
</view>
```



good_list/index.js

```js
// pages/good_list/index.js
import { request } from '../../utils/request'
Page({

  /**
   * 页面的初始数据
   */
  data: {
    params: {
      query: '', // 搜索关键字
      cid: '', // 搜索id
      pagenum: 1, // 页数
      pagesize: 10 // 每页个数
    },
    goodList: [], // 商品列表
    isDownLoad: true // 是否还有数据
  },

  /**
   * 生命周期函数--监听页面加载
   */
  onLoad: function (options) {
    // 获取url参数，调用列表接口
    const { query, cid } = options
    this.data.params.query = query || ''
    this.data.params.cid = cid || ''
    this.getGoodList()
  },

  async getGoodList() {
    const { data } = await request({
      url: '/goods/search',
      data: this.data.params
    })
    // 获取数据成功后，关闭下拉刷新窗口和加载效果
    wx.stopPullDownRefresh()
    wx.hideLoading()

    this.data.goodList.push(...data.message.goods)
    const pages = Math.ceil(data.message.total / this.data.params.pagesize)
    const currentPage = this.data.params.pagenum
    if(pages == currentPage) {
      this.setData({
        isDownLoad: false
      })
      // return
    }
    this.setData({
      goodList: this.data.goodList
    })
    if(this.data.goodList.length == 0) {
      this.setData({
        isDownLoad: false
      })
    }
  },

  onReachBottom() {
    // 页面触底事件，上拉加载
    if(this.data.isDownLoad) {
      this.data.params.pagenum++
      this.getGoodList()
    }
  },

  onPullDownRefresh() {
    // 下拉刷新
    wx.showLoading({
      title: '加载中',
      mask: true
    })
    this.setData({
      params: {
        query: '',
        cid: '',
        pagenum: 1,
        pagesize: 10
      },
      isDownLoad: true,
      goodList: []
    })
    
    this.getGoodList()
  }
})
```

- 关闭下拉刷新窗口：`wx.stopPullDownRefresh()`
- 上拉加载效果

### 5. 商品详情

<img style="width: 40%" src="./img/goods_detail.png" />



index.wxml

```html
<view class="good_detail">
    <swiper wx:if="{{goodDetail.pics.length > 0}}" class="swiper-list" indicator-dots="false" autoplay interval="2000" duration="500" circular="false">
        <swiper-item class="" wx:for="{{goodDetail.pics}}" wx:key="pics_id" bindtap="showPreviewImage" data-index="{{ index }}">
            <image class="" src="{{ item.pics_big_url }}" mode="widthFix" lazy-load />
        </swiper-item>
          
    </swiper>
    <swiper wx:else class="swiper-list" indicator-dots="false" autoplay interval="2000" duration="500" circular="false">
        <swiper-item>
            <image class="" src="https://ww1.sinaimg.cn/large/007rAy9hgy1g24by9t530j30i20i2glm.jpg" mode="widthFix" lazy-load />
        </swiper-item>
          
    </swiper>
    <view class="good-price">￥{{ goodDetail.goods_price }}</view>
    <view class="good-name">
        <text class="" selectable="false" space="false" decode="false">{{ goodDetail.goods_name }}</text>
        <view bindtap="handleLike">
            <image wx:if="{{ isLike }}" src="/icon/like.png" mode="widthFix" lazy-load="false" />
            <image wx:else class="" src="/icon/dontlike.png" mode="widthFix" lazy-load="false" />
            <text class="" selectable="false" space="false" decode="false">收藏</text>
        </view>
    </view>
    <view class="goods-introduce">
        <text>商品介绍</text>
        <rich-text nodes="{{ goodDetail.goods_introduce }}">
        </rich-text>
    </view>
    <view class="bottom-bar">
        <view class="kefu" hover-class="active">
            <text class="iconfont icon-kefu"></text>
            <text class="" selectable="false" space="false" decode="false">客服</text>
            <button class="btn" open-type="contact" ></button>
        </view>
        <view class="share" hover-class="active">
            <text class="iconfont icon-fenxiang"></text>
            <text class="" selectable="false" space="false" decode="false">分享</text>
            <button class="btn" open-type="share" ></button>
        </view>
        <view class="shopcar" hover-class="active">
            <text class="iconfont icon-gouwuche"></text>
            <text class="" selectable="false" space="false" decode="false">购物车</text>
            <navigator class="btn" target="" url="../shopcar/index" open-type="switchTab"></navigator>
        </view>
        <view class="add-shopcar" bindtap="addShopCatr">
            <text class="" selectable="false" space="false" decode="false">加入购物车</text>
        </view>
        <view class="shop">
            <text class="" selectable="false" space="false" decode="false">立即购买</text>
        </view>
    </view>
</view>
```

index.js

```js
import { request } from '../../utils/request'
Page({
  data: {
    goodDetail: {},
    isLike: false
  },
  onLoad: function (options) {
    const goods_id = options.id
    this.getGoodDetail(goods_id)
  },
  async getGoodDetail(goods_id) {
    const { data } = await request({
      url: '/goods/detail',
      data: { goods_id }
    })
    this.setData({
      goodDetail: data.message
    })
    this.isLikeRender()
    this.addFootprint()
  },
  handleLike() {
    const likes = wx.getStorageSync('likes') || []
    const index = likes.findIndex(item => item.goods.goods_id == this.data.goodDetail.goods_id)
    this.setData({
      isLike: !this.data.isLike
    })
    if(!this.data.isLike) {
      likes.splice(index, 1)
      wx.showToast({
        title: '取消成功',
        icon: 'success',
        duration: 1000
      })
    } else {
      likes.unshift({
        goods: this.data.goodDetail,
        url: '../good_detail/index?id=' + this.data.goodDetail.goods_id
      })
      wx.showToast({
        title: '收藏成功',
        icon: 'success',
        duration: 1000
      })
    }
    wx.setStorageSync('likes', likes)
  },
  showPreviewImage(e) {
    let index = e.currentTarget.dataset.index
    let images = []
    this.data.goodDetail.pics.forEach(item => {
      images.push(item.pics_big_url)
    })
    wx.previewImage({
      current: images[index], // 当前显示图片的http链接
      urls: images, // 需要预览的图片http链接列表
      // showmenu: true
    })
  },
  addShopCatr() {
    const shopCars = wx.getStorageSync('shopCars') || []
    const currentGoodId = this.data.goodDetail.goods_id
    const index = shopCars.findIndex(item => item.goods.goods_id == currentGoodId)
    if(index == -1) {
      shopCars.unshift({
        goods: this.data.goodDetail,
        num: 1,
        select: true
      })
    } else {
      shopCars[index].num++
    }
    wx.showLoading({
      title: '加载中',
    })
    setTimeout(function () {
      wx.hideLoading()
      wx.setStorageSync('shopCars', shopCars)
      wx.showToast({
        title: '加入成功',
        icon: 'success',
        duration: 2000,
        mask: true
      })
    }, 1000)
  },
  isLikeRender() {
    const likes = wx.getStorageSync('likes') || []
    const index = likes.findIndex(item => item.goods.goods_id == this.data.goodDetail.goods_id)
    if(index == -1) {
      return
    }
    this.setData({
      isLike: true
    })
  },
  addFootprint() {
    const footprints = wx.getStorageSync('footprints') || []
    const index = footprints.findIndex(item => item.goods.goods_id == this.data.goodDetail.goods_id)
    if(index > -1) {
      footprints.splice(index, 1)
    }
    footprints.unshift({
      goods: this.data.goodDetail,
      url: '../good_detail/index?id=' + this.data.goodDetail.goods_id
    })
    wx.setStorageSync('footprints', footprints)
  }
})
```

### 6. 搜索

<img style="width: 40%" src="./img/search.png" />

index.wxml

```html
<view class="search">
  <view class="search-header">
      <input
        placeholder="请输入"
        value="{{ searchText }}"
        confirm-type="send"
        bindinput="handleSearchText"
        bindconfirm="handleComfirm"
      ></input>
      <view class="search-btn" bindtap="handleSearchBtn">搜索</view>
  </view>
  <scroll-view scroll-y class="suggeste-list" wx:if="{{ searchText }}">
    <view
      class="suggeste-item"
      wx:for="{{ suggesteList }}"
      wx:key="goods_id"
      bindtap="handleSuggeste"
      data-name="{{ item.goods_name }}"
    >{{ item.goods_name }}</view>
  </scroll-view>
      
  <view class="search-history" wx:else>
    <view class="search-title" wx:if="{{ historyList.length > 0 }}">
      <text>搜索历史</text>
      <text class="iconfont icon-shanchu" bindtap="clearHistory"></text>
    </view>
    <view class="history-list">
      <text
        class="history-item"
        wx:for="{{ historyList }}"
        wx:key="*this"
        bindtap="handleHistoryClick"
        data-name="{{ item }}"
      >{{ item }}</text>
    </view>
  </view>
</view>
```

index.js

```js
// pages/search/index.js
import { request } from '../../utils/request'
import { showModal } from '../../api/wx_api'
Page({
  data: {
    searchText: '',
    suggesteList: [],
    historyList: [],
    timer: true
  },

  onShow() {
    this.setData({
      searchText: '',
      historyList: wx.getStorageSync('historyList') || [],
    })
  },

  async getsuggesteList() {
    const { data } = await request({
      url: '/goods/qsearch',
      data: {
        query: this.data.searchText.trim()
      }
    })
    this.setData({
      suggesteList: data.message
    })
  },

  handleSearchText(e) {
    this.setData({
      searchText: e.detail.value,
    })
    // 页面防抖处理
    clearTimeout(this.data.timer)
    this.data.timer = setTimeout(() => {
      this.getsuggesteList()
    }, 500)
  },

  back() {
    wx.navigateBack()
  },

  handleSearchBtn() {
    if(!this.data.searchText.trim()) {
      return
    }
    this.saveHistory(this.data.searchText)
    wx.navigateTo({
      url: '../good_list/index?query=' + this.data.searchText.trim()
    }) 
  },

  handleSuggeste(e) {
    const name = e.currentTarget.dataset.name
    this.saveHistory(name)
    wx.navigateTo({
      url: '../good_list/index?query=' + name
    })
  },

  saveHistory(value) {
    this.data.historyList.unshift(value)
    this.setData({
      historyList: this.data.historyList
    })
    wx.setStorageSync('historyList', this.data.historyList)
  },

  handleHistoryClick(e) {
    const name = e.currentTarget.dataset.name
    wx.navigateTo({
      url: '../good_list/index?query=' + name
    })
  },

  async clearHistory() {
    const isClear = await showModal('提示', '是否清空历史记录？')
    if(isClear.cancel) {
      return
    }
    this.setData({
      historyList: []
    })
    wx.setStorageSync('historyList', [])
  },

  handleComfirm() {
    this.handleSearchBtn()
  }
})
```

### 7. 购物车

<img style="width: 40%" src="./img/shopcar.png" />

index.wxml

```html
<scroll-view class="shopCar" scroll-y wx:if="{{userInfo.isLogin}}">
    <view wx:if="{{ address && address.userName }}"  bindtap="handleChooseAddress" class="address">
        <view class="username">
            <text class="" selectable="false" space="true" decode="false">收货人：{{ address.userName }}</text>
            <text class="" selectable="false" space="true" decode="false">{{ address.telNumber }}</text>
        </view>
        <view>
            {{ address.all }}
        </view>
    </view>
    <button wx:else class="addAddress" bindtap="handleChooseAddress" size="default" type="default">
        添加收货地址
    </button>
    
    <view class="shop-car">
        <view class="shop-car-title">
            购物车
        </view>
        <view class="shop-wrap" wx:if="{{ shopCarList.length > 0 }}">
            <view class="good-item" wx:for="{{ shopCarList }}" wx:key="goods_id">
                <view class="good-item-checkbox">
                    <checkbox bindtap="handleCheckbox" color="#F8554D" checked="{{ item.select }}" data-index="{{index}}"></checkbox>
                </view>
                <navigator class="good-item-detail" hover-class="none" url="{{ '../good_detail/index?id=' + item.goods.goods_id }}">
                    <view class="good-item-cover">
                        <image class="" src="{{ item.goods.goods_big_logo }}" lazy-load="false" binderror="" bindload="" />
                    </view>
                    <view class="good-item-text">
                        <view class="good-item-title">
                            {{ item.goods.goods_name }}
                        </view>
                        <view class="good-item-price-wrap">
                            <view class="good-item-price">
                                ￥{{ item.goods.goods_price }}
                            </view>
                            <view class="good-item-number">
                                <button size="mini" catchtap="handleGoodNum" data-symbol="-" data-index="{{ index }}">-</button>
                                <input value="{{ item.num }}" disabled></input>
                                <button size="mini" catchtap="handleGoodNum" data-symbol="+" data-index="{{ index }}">+</button>
                            </view>
                        </view>
                    </view>
                </navigator>
            </view>
        </view>
        <image wx:else class="no-goods" src="https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fquuluu.com%2Fshop%2Fimages%2Fcart-null.png&refer=http%3A%2F%2Fquuluu.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=jpeg?sec=1644466076&t=8508294e733faf7419978083dc2c20d4" mode="widthFix" lazy-load="false" binderror="" bindload="" />
    </view>

    <view class="account-wrap" wx:if="{{ shopCarList.length > 0 }}">
        <view class="good-item-checkbox">
            <checkbox checked="{{ allChecked }}" color="#F8554D" bindtap="handleAllCheck"></checkbox>
            <text class="">全选</text>
            <text class="total">合计{{ '￥' + currentAllPrice }}</text>
        </view>
        <view class="toPay" bindtap="handlePay">
            去结算{{ '(' + payLength + ')'}}
        </view>
    </view>
      
</scroll-view>
<button wx:else bindtap="toLogin">未登录</button>
```

index.js

```js
// pages/shopcar/index.js
import { chooseAddress, openSetting, showModal } from '../../api/wx_api'
Page({

  /**
   * 页面的初始数据
   */
  data: {
    address: {},
    shopCarList: [],
    allChecked: false,
    currentAllPrice: 0,
    payLength: 0,
    userInfo: {}
  },

  // behaviors: [require('miniprogram-computed')],

  /**
   * 生命周期函数--监听页面加载
   */
  onLoad: function (options) {
    this.showAddress()
    this.getShopCarList()
  },

  onShow() {
    this.getShopCarList()
    this.checkAll()
    this.computedTotalPrice()
    this.getUserInfo()
  },

  getUserInfo() {
    this.setData({
      userInfo: wx.getStorageSync('userInfo')
    })
  },
// 获取微信中的地址
  async handleChooseAddress() {
    try {
      const address = await chooseAddress()
      address.all = address.provinceName + address.cityName + address.countyName + address.detailInfo
      wx.setStorageSync('address', address)
      this.setData({
        address
      })
    } catch (err) {
      console.error(err)
    }
  },
// 展示地址
  showAddress() {
    const address = wx.getStorageSync('address')
    if(address) {
      this.setData({
        address
      })
    }
  },
// 获取购物车列表
  getShopCarList() {
    const shopCarList = wx.getStorageSync('shopCars') || []
    this.setData({
      shopCarList
    })
  },
// 购物者商品点击选中或取消
  handleCheckbox(e) {
    const index = e.currentTarget.dataset.index
    const isChecked = this.data.shopCarList[index].select
    this.data.shopCarList[index].select = !isChecked
    wx.setStorageSync('shopCars', this.data.shopCarList)
    this.setData({
      shopCarList: this.data.shopCarList
    })
    this.checkAll()
    this.computedTotalPrice()
  },
// 点击修改商品数量
  async handleGoodNum(e) {
    const symbol = e.currentTarget.dataset.symbol
    const index = e.currentTarget.dataset.index
    const shopCarList = wx.getStorageSync('shopCars') || []
    if(symbol == '+') {
      shopCarList[index].num++
    } else {
      if(shopCarList[index].num == 1) {
        const res = await showModal('提示', '确定要移除该商品吗？')
        if(res.confirm) {
          shopCarList.splice(index, 1)
        }
      } else {
        shopCarList[index].num--
      }
    }
    this.setData({
      shopCarList
    })
    wx.setStorageSync('shopCars', shopCarList)
    this.computedTotalPrice()
    this.checkAll()
  },
// 渲染全选框状态
  checkAll() {
    const isTrue = this.data.shopCarList.length > 0 && this.data.shopCarList.every(item => item.select)
    this.setData({
      allChecked: isTrue
    })
    this.handlePayLength()
  },
// 处理全选框选中状态
  handleAllCheck() {
    this.data.shopCarList.forEach(item => {
      item.select = !this.data.allChecked
    })
    this.setData({
      shopCarList: this.data.shopCarList
    })
    wx.setStorageSync('shopCars', this.data.shopCarList)
    this.data.allChecked = !this.data.allChecked
    this.computedTotalPrice()
    this.handlePayLength()
  },
// 计算总价
  computedTotalPrice() {
    let totalPrice = 0
    this.data.shopCarList.filter(item => item.select).forEach(item1 => {
      totalPrice += item1.num * item1.goods.goods_price
    })
    this.setData({
      currentAllPrice: totalPrice
    })
  },
// 计算选中商品的总件数
  handlePayLength() {
    let payLength = 0
    this.data.shopCarList.filter(item => item.select).forEach(item => {
      payLength += item.num
    })
    this.setData({
      payLength
    })
  },
// 处理支付按钮
  handlePay() {
    const addressAll = this.data.address.all
    if(!addressAll) {
      wx.showToast({
        title: '您还没有添加收货地址',
        icon: 'none',
        duration: 2000
      })
      return
    }
    wx.navigateTo({url: '/pages/pay/index'})
  },
// 若未登录，提示用户登录
  toLogin() {
    const userInfo = wx.getStorageSync('userInfo')
    if(!userInfo.isLogin) {
      wx.getUserProfile({
        desc: '展示用户信息', // 声明获取用户个人信息后的用途，后续会展示在弹窗中，请谨慎填写
        success: (res) => {
          wx.setStorageSync('userInfo', { isLogin: false, userInfo: res.userInfo })
          wx.navigateTo({
            url: '../login/index'
          })
        }
      })
    }
  }
})
```

### 8. 我的

<img style="width: 40%" src="./img/my.png" />

```html
<view class="my">
  <view class="my-header">
    <view class="login-info" wx:if="{{ userInfo && userInfo.isLogin }}">
      <image class="avatar" src="{{ userInfo.userInfo.avatarUrl }}"/>
      <text class="nickname">{{ userInfo.userInfo.nickName }}</text>
    </view>
    <button class="no-login" wx:else bindtap="toLogin">
      未登录
      </button>
  </view>
  <view class="user-info" wx:if="{{ userInfo && userInfo.isLogin }}">  
    <view class="record">
      <view class="record-item">
        <text class="num">0</text>
        <text class="name">收藏的店铺</text>
      </view>
      <navigator class="record-item" url="../footprints/index?index=2">
        <text class="num">{{ likes.length }}</text>
        <text class="name">收藏的商品</text>
      </navigator>
      <view class="record-item">
        <text class="num">0</text>
        <text class="name">关注的商品</text>
      </view>
      <navigator class="record-item" url="../footprints/index?index=4">
        <text class="num">{{ footprints.length }}</text>
        <text class="name">我的足迹</text>
      </navigator>
      
    </view>
    <view class="my-order">
      <view class="my-order-title">我的订单</view>
      <view class="my-order-list">
        <view class="my-order-item">
          <text class="iconfont icon-quanbudingdan"></text>
          <text class="">全部订单</text>
        </view>
        <view class="my-order-item">
          <text class="iconfont icon-daifukuan"></text>
          <text class="">代付款</text>
        </view>
        <view class="my-order-item">
          <text class="iconfont icon-icon3"></text>
          <text class="">代收货</text>
        </view>
        <view class="my-order-item">
          <text class="iconfont icon-tuikuan"></text>
          <text class="">退款/退货</text>
        </view>
      </view>
    </view>

    <view class="address">收货地址管理</view>
    <view class="our-msg">
      <view class="connect-number">
        <text class="" selectable="false" space="false" decode="false">联系客服</text>
        <text class="" selectable="false" space="false" decode="false">400-618-4000</text>
      </view>
      <button class="feedback" open-type="feedback">意见反馈</button>
      <navigator class="about-us" url="../aboutUs/index">关于我们</navigator>
    </view>
    
    <button class="recommend-other" open-type="share" onShareAppMessage="">把应用推荐给其他人</button>
    <button class="log-out" bindtap="LogOut">
      注销登录
    </button>
  </view>
</view>
```

index.js

```js
// pages/my/index.js
import { showModal, getUserProfile } from '../../api/wx_api'
Page({

  /**
   * 页面的初始数据
   */
  data: {
    userInfo: {},
    footprints: wx.getStorageSync('footprints') || [],
    likes: wx.getStorageSync('likes') || []
  },

  /**
   * 生命周期函数--监听页面加载
   */
  onShow: function (options) {
    this.getUserInfo()
    this.getFootprints()
    this.getLikes()
  },

  toLogin(e) {
    wx.getUserProfile({
      desc: '展示用户信息', // 声明获取用户个人信息后的用途，后续会展示在弹窗中，请谨慎填写
      success: (res) => {
        wx.setStorageSync('userInfo', { isLogin: false, userInfo: res.userInfo })
        wx.setStorageSync('payMsg', { payMsg: res })
        wx.navigateTo({
          url: '../login/index'
        })
      }
    })
  },

  getUserInfo() {
    const userInfo = wx.getStorageSync('userInfo')
    if(userInfo.isLogin) {
      this.setData({
        userInfo
      })
    }
  },

  async LogOut() {
    const res = await showModal('提示', '是否退出？')
    if(!res.confirm) {
      return
    }
    wx.setStorageSync('userInfo', {});
    this.setData({
      userInfo: {}
    })
  },

  getFootprints() {
    this.setData({
      footprints: wx.getStorageSync('footprints') || []
    })
  },

  getLikes() {
    this.setData({
      likes: wx.getStorageSync('likes') || []
    })
  },
// 分享配置，包括名字，封面，路由
  onShareAppMessage() {
    return {
      title: 'button',
      imageUrl: 'https://s4.ax1x.com/2022/01/14/716kkR.png',
      path: 'pages/home/index'
    }
  }
})
```

### 9. 登录

<img style="width: 40%" src="./img/login.png" />

wxml.html

```html
<view class="login">
    <image class="avatar" src="{{ userInfo.avatarUrl }}" mode="" lazy-load="false" binderror="" bindload="" />
    <text class="nickname" selectable="false" space="false" decode="false">{{ userInfo.nickName }}</text>
    <button class="button" bindtap="toLogin">确认登录</button>
</view>
```

index.js

```js
// pages/login/index.js
// import { getUserProfile } from '../../api/wx_api'
Page({

  /**
   * 页面的初始数据
   */
  data: {
    userInfo: {}
  },

  onShow() {
    this.getUserProfile()
  },

  getUserProfile() {
    const { userInfo } = wx.getStorageSync('userInfo')
    this.setData({
      userInfo
    })
  },

  toLogin() {
    wx.showLoading({
      title: '加载中',
    })
    setTimeout(() => {
      wx.setStorageSync('userInfo', {
        userInfo: this.data.userInfo,
        isLogin: true
      });
      // 跳登录后返回上级页面
      wx.navigateBack({
        delta: 1
      });
      wx.hideLoading()
      wx.showToast({
        title: '登录成功',
        icon: 'success',
        duration: 1000
      })
    }, 1000)
  }
})
```

### 10. 足迹和收藏

<img style="width: 40%" src="./img/foot.png" />

index.wxml

```html
<view class="footprints">
    <view class="shop-car">
        <view class="shop-wrap">
            <view class="good-item" wx:for="{{ footprints }}" wx:key="goods_id">
                <navigator class="good-item-detail" hover-class="none" url="{{ '../good_detail/index?id=' + item.goods.goods_id }}">
                    <view class="good-item-cover">
                        <image class="" src="{{ item.goods.goods_big_logo }}" lazy-load="false" binderror="" bindload="" />
                    </view>
                    <view class="good-item-text">
                        <view class="good-item-title">
                            {{ item.goods.goods_name }}
                        </view>
                        <view class="good-item-price-wrap">
                            <view class="good-item-price">
                                ￥{{ item.goods.goods_price }}
                            </view>
                        </view>
                    </view>
                </navigator>
            </view>
        </view>
    </view>
</view>
```

index.js

```js
Page({
  data: {
    footprints: [],
    index: 0
  },

  onLoad: function (options) {
    const { index } = options
    this.setData({
      index
    })
  },

  onShow() {
    this.getFootprints(this.data.index)
  },

  getFootprints (index){
    let list = []
    if(index == 2) {
      list = wx.getStorageSync('likes')
    } else if(index == 4) {
      list = wx.getStorageSync('footprints')
    }
    this.setData({
      footprints: list || []
    })
  }
})
```

### 11. 结算



wxml

```html
<view class="shopCar">
    <view wx:if="{{ address && address.userName }}"  bindtap="handleChooseAddress" class="address">
        <view class="username">
            <text class="" selectable="false" space="true" decode="false">收货人：{{ address.userName }}</text>
            <text class="" selectable="false" space="true" decode="false">{{ address.telNumber }}</text>
        </view>
        <view>
            {{ address.all }}
        </view>
    </view>
    <button wx:else class="addAddress" bindtap="handleChooseAddress" size="default" type="default">
        添加收货地址
    </button>
    
    <view class="shop-car">
        <view class="shop-car-title">
            购物车
        </view> 
        <scroll-view class="shop-wrap" scroll-y>
            <view class="good-item" wx:for="{{ shopCarList }}" wx:key="goods_id">
                <navigator class="good-item-detail" hover-class="none" url="{{ '../good_detail/index?id=' + item.goods.goods_id }}">
                    <view class="good-item-cover">
                        <image class="" src="{{ item.goods.goods_big_logo }}" lazy-load="false" binderror="" bindload="" />
                    </view>
                    <view class="good-item-text">
                        <view class="good-item-title">
                            {{ item.goods.goods_name }}
                        </view>
                        <view class="good-item-price-wrap">
                            <view class="good-item-price">
                                ￥{{ item.goods.goods_price }}
                            </view>
                            <view class="good-item-number">
                                X<input value="{{ item.num }}" disabled></input>
                            </view>
                        </view>
                    </view>
                </navigator>
            </view>
        </scroll-view>
    </view>

    <view class="account-wrap" wx:if="{{ shopCarList.length > 0 }}">
        <view class="good-item-checkbox">
            <text class="total">合计{{ '￥' + currentAllPrice }}</text>
        </view>
        <view class="toPay" bindtap="handlePay">
            去结算{{ '(' + payLength + ')'}}
        </view>
    </view>
</view>
```



index.js

```js
// pages/shopcar/index.js
import { getCode, requestPayment } from '../../api/wx_api'
import { request } from '../../utils/request'
Page({

  /**
   * 页面的初始数据
   */
  data: {
    address: {},
    shopCarList: [],
    allChecked: false,
    currentAllPrice: 0,
    payLength: 0
  },

  // behaviors: [require('miniprogram-computed')],

  /**
   * 生命周期函数--监听页面加载
   */
  onLoad: function (options) {
    this.showAddress()
    this.getShopCarList()
  },

  onShow() {
    this.getShopCarList()
    this.computedTotalPrice()
    this.handlePayLength()
  },

  showAddress() {
    const address = wx.getStorageSync('address')
    if(address) {
      this.setData({
        address
      })
    }
  },

  getShopCarList() {
    let shopCarList = wx.getStorageSync('shopCars') || []
    shopCarList = shopCarList.filter(item => item.select)
    this.setData({
      shopCarList
    })
  },
  computedTotalPrice() {
    let totalPrice = 0
    this.data.shopCarList.filter(item => item.select).forEach(item1 => {
      totalPrice += item1.num * item1.goods.goods_price
    })
    this.setData({
      currentAllPrice: totalPrice
    })
  },

  handlePayLength() {
    let payLength = 0
    this.data.shopCarList.filter(item => item.select).forEach(item => {
      payLength += item.num
    })
    this.setData({
      payLength
    })
  },

  async handlePay() {
    const isToken = wx.getStorageSync('token')
    if(isToken) {
      this.getOrder(token)
      return
    }
    const { code } = await getCode()
    const { payMsg } = wx.getStorageSync('payMsg')
    const { encryptedData, rawData, iv, signature } = payMsg
    const token = `Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOjIzLCJpYXQiOjE1NjQ3MzAwNzksImV4cCI6MTAwMTU2NDczMDA3OH0.YPt-XeLnjV-_1ITaXGY2FhxmCe4NvXuRnRB8OMCfnPo`
    const res = await request({
      url: '/users/wxlogin',
      method: 'POST',
      data: { encryptedData, rawData, iv, signature, code }
    })
    wx.setStorageSync('token', token)
    console.log(res)
    
  },

  async getOrder(token) {
    const goods = []
    this.data.shopCarList.forEach(item => {
      goods.push({
        goods_id: item.goods.goods_id,
        goods_number: item.num,
        goods_price: item.goods.goods_price
      })
    })
    await request({
      url: '/my/orders/create',
      method: 'POST',
      data: {
        order_price: this.data.currentAllPrice,
        consignee_addr: wx.getStorageSync('address').all,
        goods: goods
      },
      header: {
        Authorization: token
      }
    })
    const order_number = 'HMDD20190802000000000422'
    request({
      url: '/my/orders/req_unifiedorder',
      method: 'POST',
      data: { order_number },
      header: { Authorization: token }
    })
    
    // const res = requestPayment = await requestPayment()
    // console.log(res)
    wx.requestPayment({
      timeStamp: '',
      nonceStr: '',
      package: '',
      signType: '',
      paySign: '',
      success: (result) => {
        console.log('成功')
        // resolve(result)
      },
      fail: () => {}
    })
  }
})
```



# 四、云开发

## 1. 云服务配置及初始化

- `project.config.json`

  ```json
  {
      "cloudfunctionRoot": "cloud"
  }
  ```

- 在根目录新建 `cloud`文件夹

- `app.js`

  ```js
  App({
      onLaunch() {
          wx.cloud.init({
              env: "cloud1-9g6emr91e0020288" // 环境id
      		traceUser: true // 是否在将用户访问记录到用户管理中，在控制台中可见
          })
      }
  })
  ```



## 2. 云数据库

### 2.1 数据的增删改查

#### 2.1.1 增

- 插入一条数据

  支持 `success` 回调，也只是 `promise`

  ```js
  // 连接数据库
  const db = wx.cloud.database().collection('lists')
  Page({
      addData() {
          // 写入一条数据
          db.add({
              // 数据
              data: {
                  name: '王五'
              },
              // 写入成功的回调
              success(res) {
                  console.log(res)
              },
              // 写入失败的回调
              fail(err) {
                  console.log(err)
              }
          })
      }
  })
  ```

  



#### 2.1.2 删

- 删除指定id

  `db.doc(id)`：获取到指定id的数据

  ```js
  delData() {
      db.doc('6d85a2b962749aeb01ef37c2533dc86e').remove({
          success(res) {
              console.log(res)
          },
          fail(err) {
              console.log(err)
          }
      })
  }
  ```

  

#### 2.1.3 改

- 修改指定id 的数据

  ```js
  updateData() {
      db.doc('058dfefe62749981019f2bc248f895a8').update({
          data: {
              name: 'hello world!!',
              age: 250
          },
          success(res) {
              console.log(res)
          }
      })
  }
  ```

  

#### 2.1.4 查

- 查看整个列表

  ```js
  async getData() {
      db.get({
          success(res) {
              console.log(res)
          },
          fail(err) {
              console.log(err)
          }
      })
  }
  ```

- 获取多条数据

  ```js
  async getData() {
      const res = await db.where({
          name: '张'
      }).get()
      console.log(res)
  }
  ```

- 获取指定id 的数据

  ```js
  async getData() {
      const res = await db.doc('指定的id').get()
      console.log(res)
  }
  ```

  

## 3. 云函数

### 3.1 创建云函数

右键 `新建nodejs云函数`  

### 3.2 封装云函数

```js
// 云函数入口文件sdk
const cloud = require('wx-server-sdk')
// 初始化云函数
cloud.init()

// 云函数入口函数
exports.main = async (event, context) => {
    const a = event.a
    const b = event.b
    return a + b
}
```



### 3.3 上传部署云函数

右键 `上传并部署`, 不上传 `node_modules`

### 3.4 调用云函数

```js
Page({
    async add() {
        try {
            const res = await wx.cloud.callFunction({
                name: 'add',
                data: {
                    a: 10,
                    b: 12
                }
            })
            console.log(res)
        } catch(err) {
            console.log(err)
        }
    }

    add() {
        wx.cloud.callFunction({
            name: 'add',
            data: {
                a: 1,
                b: 3
            },
            success(res) {
                console.log(res)
            },
            fail(err) {
                console.log(err)
            }
        })
    }
})
```

#### 3.4.1 云函数获取用户open_id

```js
// 云函数入口文件
const cloud = require('wx-server-sdk')

cloud.init()

// 云函数入口函数
exports.main = async (event, context) => {
    const wxContext = cloud.getWXContext()
    return {
        cloud,
        context,
        event,
        wxContext
    }
}
```

4个对象各表示什么

```js
event: {
    appId: "wx74a7552006f3417f"
	openId: "oFxcV5PMD7c1595NtWrk1zgo3aGU"
}
wxContext: {
    APPID: "wx74a7552006f3417f"
    CLIENTIP: "223.72.36.95"
    CLIENTIPV6: "::ffff:223.72.36.95"
    ENV: "cloud1-9g6emr91e0020288"
    FROM_APPID: ""
    FROM_OPENID: ""
    FROM_UNIONID: ""
    OPENID: "oFxcV5PMD7c1595NtWrk1zgo3aGU"
    OPEN_DATA_INFO: ""
    SOURCE: "wx_devtools"
    UNIONID: ""
}
context: {
    callbackWaitsForEmptyEventLoop: true,
    function_name: "get_open_id"
    function_version: "$LATEST"
    memory_limit_in_mb: 256
    namespace: "cloud1-9g6emr91e0020288"
    request_id: "5106f551-8cbe-47d0-899a-d5c6e1e84ae4"
    tencentcloud_appid: "1310597977"
    tencentcloud_region: "ap-shanghai"
    tencentcloud_uin: "100024631862"
    time_limit_in_ms: 3000
    environ: "WX_APPID=wx74a7552006f3417f;WX_API_TOKEN=eyJFbmNyeXB0QWxnbyI6IkVOQ1JZUFRfQUxHT19BTExfTk9ORSIsIlZlcnNpb24iOjEsIktleVZlcnNpb24iOjAsIkVuY3J5cHRLZXkiOiIiLCJ0aWNrZXQiOiJDQUFTcndJS0hHOUdlR05XTlZCTlJEZGpNVFU1TlU1MFYzSnJNWHBuYnpOaFIxVVNFbmQ0TnpSaE56VTFNakF3Tm1Zek5ERTNaaHBzU0Vad2RYaHRRMmxEWDBka1NVaDBkaTEwY21vMmFYVlJSV2RSY2xsNVpFZE9TVll0ZDAwd1JGcHBVRkI1V1haM1JEbFBjM1ZJT0RGdGRHMUVkWEF5YkUxWGR6RlNOV2xJV0RRdE5HSnROVlZsTUhaVGVFbE9jMTlvV0V0TllXWjFiVTV2V0MxamEwSnhWM3BhSU5NUEtMUE5uWWdFTUxHbDA1TUdPZ0JDZWdvZ2d5bDZ0K1I1bFgwQlA5UmdGRDY3ZGVLekFBQUFBQUFBQUFBQUFBQUFBQUFTQzJkbGRGOXZjR1Z1WDJsa0lBTW9BRElnTnpNeE9UbG1aRFZqTURjek5UTTVOMll6TkdObVpqTmlZV1kyTTJNMVpHUTRwY0d0M3daQWw2N1VvQTVxRjJOc2IzVmtNUzA1WnpabGJYSTVNV1V3TURJd01qZzRTQUVZQUNBQiIsImV2ZW50SWQiOiJIRnB1eG1DaUNfR2RJSHR2LXRyajZpdVFFZ1FyWXlkR05JVi13TTBEWmlQUHlZdndEOU9zdUg4MW10bUR1cDJsTVd3MVI1aUhYNC00Ym01VWUwdlN4SU5zX2hYS01hZnVtTm9YLWNrQnFXeloifQ==;WX_CONTEXT_KEYS=WX_UNIONID,WX_CLIENTIP,WX_CLIENTIPV6,WX_FROM_APPID,WX_FROM_OPENID,WX_FROM_UNIONID,WX_OPEN_DATA_INFO,WX_APPID,WX_OPENID,WX_API_TOKEN;TCB_CONTEXT_KEYS=TCB_ENV,TCB_SEQID,TRIGGER_SRC,TCB_ISANONYMOUS_USER,TCB_SESSIONTOKEN,TCB_SOURCE,TCB_ROUTE_KEY,TCB_CONTEXT_CNFG;TENCENTCLOUD_SECRETID=AKIDvxQNTRfr7sHCjz6RagAOeT_feocGB2mp_tRldnQKhYy4w9KJoXfLtNYa9Y0sfOj1;TENCENTCLOUD_SECRETKEY=7Cqp06eO3mOTqeuN7ynlfEhDQixVd6tXFupq4HqnQa8=;WX_CLIENTIP=223.72.36.95;TCB_SEQID=1651823281163_0.27656113595927767_33613764;TCB_SOURCE=wx_devtools;TCB_ROUTE_KEY=18;WX_UNIONID=;WX_CLIENTIPV6=::ffff:223.72.36.95;WX_FROM_APPID=;WX_FROM_OPENID=;WX_OPEN_DATA_INFO=;WX_OPENID=oFxcV5PMD7c1595NtWrk1zgo3aGU;TCB_SESSIONTOKEN=5bzW4gbeBpQHG7fdfnQWcAMzVUqIb7fa67f087cea8bd1418f6b0f6d3726b0d87EvI6Of6T0xM4UNNsbFj1jGPgKDv5nhWyiKMVQaQVRHMvi34Z8rO3FBfN4XIUwyTrXPpbUn08H_3mDM1sKv0sgvDJDW2rxvqA7jhInxd-TFScHqZLuKwFpplI5exTvyaKYaBHaGe4Opd5Ro_dmpObLEgkHfsyKIoqw5xuUkeX91NnoVxNAFpUs7F4MFWPDWuJilIMHmJnXQeJyjVPsqf58wyosaMqGX7rHRWYt5EjQVELKkhH5d6-jD2w3GUOMP5Cdmi9B_5rIxdz7VfMH0LmJ0OeGfEVqFR9PBBXNNFRGTwHUXqH1tVqDBdEMxFSqLEcsSaFLofFqR_dxpegQ7aag7JWdQNXCoHnN3CNAFxFr0w;TCB_CONTEXT_CNFG={"TCB_SDK_GRAY_0":true,"URL":"http://169.254.0.131:80/admin"};SCF_NAMESPACE=cloud1-9g6emr91e0020288;WX_FROM_UNIONID=;TCB_ENV=cloud1-9g6emr91e0020288;TRIGGER_SRC=tcb;TCB_ISANONYMOUS_USER=false;TENCENTCLOUD_SESSIONTOKEN=JPPvi0TmdYT8IrSwJLnVWMM0a3tD6O3a3639eea89419debbb44c510c59118e89VorRfhHmt7qNCOFF2Iv1iZn0YJt8KkayAlN7XUhY_nHgNeIYx1GQczpf4RroFZ8_Zmhdh7Q7Kd9Xbm40vfIWP9UUJ1kl0TchrO-Y7qttEYAT4PWOTu179LNbty-AHCLxX2-0Ty9mPIBKWFAVjzFxKy25u73eqpbfiZfNEabQXzuajS3fRm7cYOTODsTz2QWAJz0kCwyB_363hGiVtdCT7E6ETcfKUoyYhDHrJQyfgKufh5w0OmcjzRI-E6qyP7S--Rh-ij7e_75mDZ2RvNOrWUMNbSTN1zaw0BnESjLd8ltoOhGDFRq1PsW3GRrd4thfn_z14B8yuVW25pRStyAbd2bpPpakX8UcXVMWRnjd1ys;SCF_NAMESPACE=cloud1-9g6emr91e0020288"
    environment: "{"SCF_NAMESPACE":"cloud1-9g6emr91e0020288","TCB_CONTEXT_CNFG":"{\"TCB_SDK_GRAY_0\":true,\"URL\":\"http://169.254.0.131:80/admin\"}","TCB_CONTEXT_KEYS":"TCB_ENV,TCB_SEQID,TRIGGER_SRC,TCB_ISANONYMOUS_USER,TCB_SESSIONTOKEN,TCB_SOURCE,TCB_ROUTE_KEY,TCB_CONTEXT_CNFG","TCB_ENV":"cloud1-9g6emr91e0020288","TCB_ISANONYMOUS_USER":"false","TCB_ROUTE_KEY":"18","TCB_SEQID":"1651823281163_0.27656113595927767_33613764","TCB_SESSIONTOKEN":"5bzW4gbeBpQHG7fdfnQWcAMzVUqIb7fa67f087cea8bd1418f6b0f6d3726b0d87EvI6Of6T0xM4UNNsbFj1jGPgKDv5nhWyiKMVQaQVRHMvi34Z8rO3FBfN4XIUwyTrXPpbUn08H_3mDM1sKv0sgvDJDW2rxvqA7jhInxd-TFScHqZLuKwFpplI5exTvyaKYaBHaGe4Opd5Ro_dmpObLEgkHfsyKIoqw5xuUkeX91NnoVxNAFpUs7F4MFWPDWuJilIMHmJnXQeJyjVPsqf58wyosaMqGX7rHRWYt5EjQVELKkhH5d6-jD2w3GUOMP5Cdmi9B_5rIxdz7VfMH0LmJ0OeGfEVqFR9PBBXNNFRGTwHUXqH1tVqDBdEMxFSqLEcsSaFLofFqR_dxpegQ7aag7JWdQNXCoHnN3CNAFxFr0w","TCB_SOURCE":"wx_devtools","TENCENTCLOUD_SECRETID":"AKIDvxQNTRfr7sHCjz6RagAOeT_feocGB2mp_tRldnQKhYy4w9KJoXfLtNYa9Y0sfOj1","TENCENTCLOUD_SECRETKEY":"7Cqp06eO3mOTqeuN7ynlfEhDQixVd6tXFupq4HqnQa8=","TENCENTCLOUD_SESSIONTOKEN":"JPPvi0TmdYT8IrSwJLnVWMM0a3tD6O3a3639eea89419debbb44c510c59118e89VorRfhHmt7qNCOFF2Iv1iZn0YJt8KkayAlN7XUhY_nHgNeIYx1GQczpf4RroFZ8_Zmhdh7Q7Kd9Xbm40vfIWP9UUJ1kl0TchrO-Y7qttEYAT4PWOTu179LNbty-AHCLxX2-0Ty9mPIBKWFAVjzFxKy25u73eqpbfiZfNEabQXzuajS3fRm7cYOTODsTz2QWAJz0kCwyB_363hGiVtdCT7E6ETcfKUoyYhDHrJQyfgKufh5w0OmcjzRI-E6qyP7S--Rh-ij7e_75mDZ2RvNOrWUMNbSTN1zaw0BnESjLd8ltoOhGDFRq1PsW3GRrd4thfn_z14B8yuVW25pRStyAbd2bpPpakX8UcXVMWRnjd1ys","TRIGGER_SRC":"tcb","WX_API_TOKEN":"eyJFbmNyeXB0QWxnbyI6IkVOQ1JZUFRfQUxHT19BTExfTk9ORSIsIlZlcnNpb24iOjEsIktleVZlcnNpb24iOjAsIkVuY3J5cHRLZXkiOiIiLCJ0aWNrZXQiOiJDQUFTcndJS0hHOUdlR05XTlZCTlJEZGpNVFU1TlU1MFYzSnJNWHBuYnpOaFIxVVNFbmQ0TnpSaE56VTFNakF3Tm1Zek5ERTNaaHBzU0Vad2RYaHRRMmxEWDBka1NVaDBkaTEwY21vMmFYVlJSV2RSY2xsNVpFZE9TVll0ZDAwd1JGcHBVRkI1V1haM1JEbFBjM1ZJT0RGdGRHMUVkWEF5YkUxWGR6RlNOV2xJV0RRdE5HSnROVlZsTUhaVGVFbE9jMTlvV0V0TllXWjFiVTV2V0MxamEwSnhWM3BhSU5NUEtMUE5uWWdFTUxHbDA1TUdPZ0JDZWdvZ2d5bDZ0K1I1bFgwQlA5UmdGRDY3ZGVLekFBQUFBQUFBQUFBQUFBQUFBQUFTQzJkbGRGOXZjR1Z1WDJsa0lBTW9BRElnTnpNeE9UbG1aRFZqTURjek5UTTVOMll6TkdObVpqTmlZV1kyTTJNMVpHUTRwY0d0M3daQWw2N1VvQTVxRjJOc2IzVmtNUzA1WnpabGJYSTVNV1V3TURJd01qZzRTQUVZQUNBQiIsImV2ZW50SWQiOiJIRnB1eG1DaUNfR2RJSHR2LXRyajZpdVFFZ1FyWXlkR05JVi13TTBEWmlQUHlZdndEOU9zdUg4MW10bUR1cDJsTVd3MVI1aUhYNC00Ym01VWUwdlN4SU5zX2hYS01hZnVtTm9YLWNrQnFXeloifQ==","WX_APPID":"wx74a7552006f3417f","WX_CLIENTIP":"223.72.36.95","WX_CLIENTIPV6":"::ffff:223.72.36.95","WX_CONTEXT_KEYS":"WX_UNIONID,WX_CLIENTIP,WX_CLIENTIPV6,WX_FROM_APPID,WX_FROM_OPENID,WX_FROM_UNIONID,WX_OPEN_DATA_INFO,WX_APPID,WX_OPENID,WX_API_TOKEN","WX_FROM_APPID":"","WX_FROM_OPENID":"","WX_FROM_UNIONID":"","WX_OPENID":"oFxcV5PMD7c1595NtWrk1zgo3aGU","WX_OPEN_DATA_INFO":"","WX_UNIONID":""}"
}
```

#### 3.4.2 云函数中执行数据库

```js
// 云函数入口文件
const cloud = require('wx-server-sdk')
cloud.init({
    env: "cloud1-9g6emr91e0020288"
})
const db = cloud.database().collection('lists')


// 云函数入口函数
exports.main = async (event, context) => {
    return db.get()
}
```

**注**：云函数获取数据不受数据库权限的限制



## 4. 云存储

### 4.1 上传

- 上传图片

  ```js
  upload() {
      wx.chooseImage({
          count: 1,
          sizeType: ['original', 'compressed'],
          success: res => {
              // 获取到小程序临时文件url
              this.uploadCloud(res.tempFilePaths[0])
          }
      })
  },
      uploadCloud(path) {
          wx.cloud.uploadFile({
              cloudPath: 'aaa.png', // 上传至云端的路径
              filePath: path, // 小程序临时文件路径
              success: res => {
                  // 返回文件 ID
                  console.log(res)
              }
          })
      }
  ```

- 上传视频

  ```js
  uploadVideo() {
      wx.chooseVideo({
          camera: 'front',
          success: res => {
              this.uploadCloud(res.tempFilePath)
          }
      })
  },
  uploadCloud(path) {
      wx.cloud.uploadFile({
          cloudPath: `${Date.now()}.mp4`, // 上传至云端的路径
          filePath: path, // 小程序临时文件路径
          success: res => {
              // 返回文件 ID
              this.setData({
                  url2: res.fileID
              })
          console.log(res)
          }
      })
  }
  ```

- 上传excel，word，pdf等文档，并自动打开

  ```js
  // 上传文件获取临时url
  uploadPdf() {
      wx.chooseMessageFile({
          count: 1,
          success: res => {
              // 储存
              this.uploadCloud(res.tempFiles[0].path, res.tempFiles[0].path.split('.').pop())
              // loading
               wx.showLoading({
                   title: '正在打开',
               })
              // 打开文件
               wx.openDocument({
                   filePath: res.tempFiles[0].path,
                   fileType: res.tempFiles[0].path.split('.').pop(),
                   success(res) {
                       wx.hideLoading()
                       console.log('打开成功')
                   }
               })
          }
      })
  },
  
  uploadCloud(path, exc) {
      wx.cloud.uploadFile({
          cloudPath: `${Date.now()}.${exc}`, // 上传至云端的路径
          filePath: path, // 小程序临时文件路径
          success: res => {
              // 返回文件 ID
              console.log('储存成功')
          }
      })
  },
  ```

### 4.2 下载

```js
wx.cloud.downloadFile({
    fileID: url, // 文件 ID
    success: res => {
        // 返回临时文件路径
        console.log()
    }
})
```

下载并打开文件

```js
wx.cloud.downloadFile({
    fileID: url, // 文件 ID
    success: res => {
        // 返回临时文件路径
        wx.openDocument({
            // 文件路径
            filePath: res.tempFilePath,
            // 文件后缀
            fileType: res.tempFilePath.split('.').pop(),
            success(res) {
                console.log('打开成功')
            }
        })
    }
})
```











